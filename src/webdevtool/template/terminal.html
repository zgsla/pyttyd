<!DOCTYPE html>
<html translate="no">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="{{ url_for('static', path='/css/bootstrap.min.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', path='/css/xterm.css') }}">
</head>
<body>
  <div class="container-fruid">
    <div id="terminal"></div>
  </div>
</body>
<script src="{{ url_for('static', path='/js/xterm.js') }}"></script>
<script src="{{ url_for('static', path='/js/xterm-addon-fit.js') }}"></script>
<script src="{{ url_for('static', path='/js/jsencrypt.min.js') }}"></script>
<script src="{{ url_for('static', path='/js/crypto-js.js') }}"></script>
<script type="module">
  // $(function() {
  // });

  // 修改terminal的高度为body的高度
  document.getElementById('terminal').style.height = (window.innerHeight * 0.999) + 'px';
  // document.getElementById('terminal').style.width = window.innerWidth + 'px';
  
  var encrypt = new JSEncrypt();
  encrypt.setPublicKey('{{ publickey }}');
  
  window.addEventListener('message',e => {

    console.log(e.data,'父页面发送来的数据');
    // xterm docs https://xtermjs.org/docs/api/terminal/classes/terminal/
    const term = new Terminal({
      cursorStyle:'underline',  //光标样式
      cursorBlink:true,  //光标闪烁
    });
    const fitAddon = new FitAddon.FitAddon();
  
    term.focus();
    term.open(document.getElementById('terminal'));
    term.loadAddon(fitAddon);
    fitAddon.fit();

    var aesKey = CryptoJS.lib.WordArray.random(32);
    var aesIV = CryptoJS.lib.WordArray.random(16);
    var aesPass = JSON.stringify({
        'key': aesKey.toString(CryptoJS.enc.Base64),
        'iv': aesIV.toString(CryptoJS.enc.Base64)
    })
    var aesPassEncrypted = encrypt.encrypt(aesPass);
    var encrypted = CryptoJS.AES.encrypt(
        CryptoJS.enc.Utf8.parse(e.data),
        aesKey,
        {
            iv: aesIV,
            mode: CryptoJS.mode.CBC,
            padding: CryptoJS.pad.Pkcs7
        }
    );
    var token = CryptoJS.enc.Base64.stringify(encrypted.ciphertext)
    document.cookie = 'session=' + aesPassEncrypted
    var ws = new WebSocket("ws://127.0.0.1:8000/ssh/connect?token=" + encodeURIComponent(token) + '&cols=' + term.cols + '&rows=' + term.rows); 
    //申请一个WebSocket对象，参数是服务端地址，同http协议使用http://开头一样，WebSocket协议的url使用ws://开头，另外安全的WebSocket协议使用wss://开头
    ws.onopen = function(){
      //当WebSocket创建成功时，触发onopen事件
      console.log("open");
    }
    ws.onmessage = function(e){
      //当客户端收到服务端发来的消息时，触发onmessage事件，参数e.data包含server传递过来的数据
      term.write(e.data);
    }
    ws.onclose = function(e){
      //当客户端收到服务端发送的关闭连接请求时，触发onclose事件
      alert('连接关闭\n原因: ' + e.reason)
      console.log("close");
    }
    ws.onerror = function(e){
      //如果出现连接、处理、接收、发送数据失败的时候触发onerror事件
      console.log(error);
    }

    term.onData(function(s){
      ws.send(JSON.stringify({"input": s}))
    });

    window.onresize = function(){
      document.getElementById('terminal').style.height = (window.innerHeight * 0.999) + 'px';
      // document.getElementById('terminal').style.width = window.innerWidth + 'px';
      fitAddon.fit();
    }

    term.onResize(function (size) {
      ws.send(JSON.stringify({
        'resize': [size.cols, size.rows]
      }));
      
    })

  })

  window.addEventListener('load',() =>{
    console.log('load')
    window.opener.postMessage('子页面加载完成');

  })
  // term.onKey(function(obj){
  //   console.log(obj);
  // })
  
  // $('#terminal').bind("contextmenu",function(e){
  //   return false;
  // });

  // $('#terminal').mousedown(function(e) {
  //   // e.which 1鼠标左键，2中键，3右键
  //   if (e.which == 3){
  //     console.log('mouse right key');
      
  //     if (term.hasSelection()){
  //       this.selection = term.getSelection(); // 复制到临时属性
  //       term.clearSelection()
  //     } else if (this.selection) {
  //       term.paste(this.selection)
  //     }
      
  //   }
  // })

</script>
</html>